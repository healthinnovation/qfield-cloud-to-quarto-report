name: ğŸ”„ Actualizar base de datos desde QFieldCloud â˜ï¸

on:
  # schedule:
  #- cron: '10 21 * * *'  # 4:00 PM todo los dÃ­as hora PerÃº
  workflow_dispatch:

jobs:
  actualizar-gpkg:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar repositorio ğŸ“¥
        uses: actions/checkout@v3
        with:
          persist-credentials: true # â¬…ï¸ necesario para permitir git push

      - name: InstalaciÃ³n de Python ğŸ¤–
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: InstalaciÃ³n de dependencias ğŸš€
        run: |
          pip install geopandas qfieldcloud-sdk pandas pytz

      - name: Nueva carpeta de salida ğŸ“‚
        run: mkdir -p output

      - name: Ejecutar script principal ğŸ
        run: python main.py
        env:
          QFIELD_USER: ${{ secrets.QFIELD_USER }}
          QFIELD_PASS: ${{ secrets.QFIELD_PASS }}
          QFIELD_PROJECT_ID: ${{ secrets.QFIELD_PROJECT_ID }}

      - name: Guardar base de datos actualizados âœ”ï¸ğŸ“„
        uses: actions/upload-artifact@v4
        with:
          name: archivos-generados
          path: output/

      - name: Eliminar gpkg y subir uno nuevo a qfieldcloud ğŸ—‘ï¸âŒ¯âŒ²
        run: rm -f output/*.gpkg

      - name: Hacer commit y push si hubo cambios ğŸš€
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add output/

          if git diff --cached --quiet; then
            echo "âœ… No hay cambios para commitear."
          else
            git commit -m "ğŸ”„ ActualizaciÃ³n automÃ¡tica desde QFieldCloud - $(date -u +"%Y-%m-%d %H:%M:%S")"
            git push origin main
            echo "ğŸš€ Cambios subidos al repositorio."
          fi
